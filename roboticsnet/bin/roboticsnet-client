#!/usr/bin/env python2.7

import sys
import argparse

from roboticsnet.rover_client import RoverClient
from roboticsnet.gateway_constants import *
from roboticsnet.roboticsnet_exception import RoboticsnetException

from colorama import Fore

# Configuration
parser = argparse.ArgumentParser('roboticsnet-client')

parser.add_argument('--forward',
        help='send forward command, given a value from 1 to 63',
        type=int)

parser.add_argument('--reverse',
        help='send reverse command, given a value from 1 to 63',
        type=int)

parser.add_argument('--forwardLeft',
        help='send forward left command, given a value from 1 to 63',
        type=int)

parser.add_argument('--forwardRight',
        help='send forward right command, given a value from 1 to 63',
        type=int)

parser.add_argument('--reverseLeft',
        help='send reverse left command, given a value from 1 to 63',
        type=int)

parser.add_argument('--reverseRight',
        help='send reverse right command, given a value from 1 to 63',
        type=int)

parser.add_argument('--stop',
        help='send command to stop all motors',
        action='store_true')

parser.add_argument('--queryproc',
        help='send query about what is currently running',
        action='store_true')

parser.add_argument('--graceful',
        help='shutdown server gracefully',
        action='store_true')

parser.add_argument('--host',
        help='specify an alternate host to default localhost')

parser.add_argument('--port',
        help='specify an alternate port to default 5000',
        type=int)

parser.add_argument('--testall',
        help='sends a command of each',
        action='store_true')

parser.add_argument('--startvid',
        help='request video to start running',
        action='store_true')

parser.add_argument('--stopvid',
        help='request video to stop running',
        action='store_true')

parser.add_argument('--sensinfo',
        help='request sensor information',
        action='store_true')

parser.add_argument('--snapshot',
        help='take snapshot on rover',
        action='store_true')

parser.add_argument('--panoramicSnapshot',
        help='take panoramic snapshot on rover',
        action='store_true')

args = parser.parse_args()

# These will be overwritten if --port, or --host is supplied
host, port = 'localhost', ROBOTICSNET_TCP_PORT

if args.host:
    host = args.host

if args.port:
    port = args.port

##### RUN
client = RoverClient(host, port)

def _forward():
    print "Send " + Fore.BLUE + "forward" + Fore.RESET + " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_FORWARD,args.forward)
    print Fore.GREEN, "Done!", Fore.RESET

def _reverse():
    print "Send " + Fore.BLUE + "reverse" + Fore.RESET + " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_REVERSE,args.reverse)
    print Fore.GREEN, "Done!", Fore.RESET

def _forwardLeft():
    print "Send " + Fore.BLUE + "forward left" + Fore.RESET+ " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_FORWARDLEFT,args.forwardLeft)
    print Fore.GREEN, "Done!", Fore.RESET

def _forwardRight():
    print "Send " + Fore.BLUE + "forward right" + Fore.RESET+ " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_FORWARDRIGHT,args.forwardRight)
    print Fore.GREEN, "Done!", Fore.RESET

def _reverseLeft():
    print "Send " + Fore.BLUE + "reverse left" + Fore.RESET+ " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_REVERSELEFT,args.reverseleft)
    print Fore.GREEN, "Done!", Fore.RESET

def _reverseRight():
    print "Send " + Fore.BLUE + "reverse right" + Fore.RESET+ " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_REVERSERIGHT,args.reverseRight)
    print Fore.GREEN, "Done!", Fore.RESET

def _stop():
    print "Send " + Fore.BLUE + "stop" + Fore.RESET+ " command...",
    client.timedCommand(ROBOTICSNET_DRIVE_STOP)
    print Fore.GREEN, "Done!", Fore.RESET

def _queryproc():
    print "Send " + Fore.BLUE + "query" + Fore.RESET + " to listener...",
    reply = client.query()
    print Fore.GREEN, "Done!", Fore.RESET

def _startVideo():
    print "Send " + Fore.BLUE + "startvid" + Fore.RESET + " to listener...",
    client.sendCommand(ROBOTICSNET_CAMERA_START_VID)
    print Fore.GREEN, "Done!", Fore.RESET

def _stopVideo():
    print "Send " + Fore.BLUE + "stopvid" + Fore.RESET + " to listener...",
    client.sendCommand(ROBOTICSNET_CAMERA_STOP_VID)
    print Fore.GREEN, "Done!", Fore.RESET

def _snapshot():
    print "Send " + Fore.BLUE + "snapshot" + Fore.RESET + " to listener...",
    client.sendCommand(ROBOTICSNET_CAMERA_SNAPSHOT)
    print Fore.GREEN, "Done!", Fore.RESET

def _panoramicSnapshot():
    print "Send " + Fore.BLUE + "panoramic snapshot" + Fore.RESET + " to listener...",
    client.sendCommand(ROBOTICSNET_CAMERA_PANORAMICSNAPSHOT)
    print Fore.GREEN, "Done!", Fore.RESET

def _graceful():
    print "Requesting " + Fore.BLUE + "shutdown" + Fore.RESET + "...",
    client.sendCommand(ROBOTICSNET_SYSTEM_GRACEFUL)
    print Fore.GREEN, "Done!", Fore.RESET


def _testAll():
    """ Test all commands with dummy data """
    args.forward = 233
    #args.turn = 22
    #should all of the commands be here???
    args.reverse = 0xbb

    # Make sure _graceful is in the end
    calls = [_forward, _reverse, _forwardLeft, _forwardRight, _reverseLeft, _reverseRight, _stop, _startVideo, _stopVideo,
             _queryproc, _graceful]

    print Fore.MAGENTA + "Testing all commands..." + Fore.RESET
    for c in calls:
        c()

try:
    if   args.forward:      _forward()
    elif args.forwardLeft:     _forwardLeft()
    elif args.forwardRight:    _forwardRight()
    elif args.reverseLeft:  _reverseLeft()
    elif args.reverseRight: _reverseRight()
    elif args.stop:         _stop()
    elif args.reverse:      _reverse()
    elif args.queryproc:    _queryproc()
    elif args.graceful:     _graceful()
    elif args.testall:      _testAll()
    elif args.stopvid:      _stopVideo()
    elif args.startvid:     _startVideo()
    elif args.snapshot:     _snapshot()
    elif args.panoramicSnapshot:    _panoramicSnapshot()
    else: raise RoboticsnetException("Unable to associate parsed args: " + ", ".join(sys.argv))

except RoboticsnetException as e:
    print "Something wrong happened!"
    print Fore.RED, e.message, Fore.RESET

except Exception as e:
    print Fore.RED, "Something terribly wrong happened."
    print "It would probably be a good idea to file a bug report", Fore.RESET
    print e.message
